<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voting Dashboard Anggota - EEPROM POLINEMA</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="icon" href="/images/eeprom_logo.png" type="image/png">
    <style>
        :root {
            --primary-blue: #1A237E;
            --secondary-blue: #3F51B5;
            --accent-orange: #FF5722;
            --light-gray: #F8F9FA;
            --medium-gray: #E8EAF6;
            --dark-text: #212529;
            --soft-text: #495057;
            --shadow-custom: 0 10px 30px rgba(0, 0, 0, 0.1);
            --success-green: #10b981;
        }

        * {
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background-color: var(--medium-gray);
            min-height: 100vh;
            padding: 20px 0;
        }

        /* Header Section */
        .voting-header {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-custom);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .user-info-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 1.5rem;
            backdrop-filter: blur(10px);
        }

        .user-badge {
            background: white;
            color: var(--primary-blue);
            display: inline-flex;
            align-items: center;
            padding: 0.4rem 1rem;
            border-radius: 8px;
            margin: 0.25rem;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .user-badge i {
            margin-right: 0.5rem;
        }

        /* Main Container */
        .voting-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Alert Box */
        .alert-custom {
            border-radius: 12px;
            padding: 1rem 1.25rem;
            margin-bottom: 1.5rem;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* Voting Status Card */
        .voting-status-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-custom);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: #f1f5f9;
            border-radius: 10px;
        }

        .status-icon {
            width: 50px;
            height: 50px;
            background: var(--success-green);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }

        /* Candidate Cards */
        .candidates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .candidate-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: var(--shadow-custom);
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }

        .candidate-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }

        .candidate-card.selected {
            border-color: var(--success-green);
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
        }

        .candidate-header {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
            color: white;
            padding: 1rem;
            text-align: center;
        }

        .candidate-number {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }

        .candidate-photo {
            width: 100%;
            height: 280px;
            object-fit: cover;
            background: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .candidate-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .candidate-photo.no-photo {
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
            color: #94a3b8;
            font-size: 4rem;
        }

        .candidate-body {
            padding: 1.5rem;
        }

        .candidate-name {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--dark-text);
            margin-bottom: 0.5rem;
        }

        .candidate-position {
            color: var(--secondary-blue);
            font-weight: 600;
            margin-bottom: 1rem;
            font-size: 0.95rem;
        }

        .vote-button {
            width: 100%;
            padding: 0.875rem;
            border-radius: 10px;
            border: 2px solid var(--secondary-blue);
            background: white;
            color: var(--secondary-blue);
            font-weight: 700;
            font-size: 1rem;
            transition: all 0.3s;
            margin-top: 1rem;
        }

        .vote-button:hover:not(:disabled) {
            background: var(--secondary-blue);
            color: white;
            transform: translateY(-2px);
        }

        .vote-button.selected {
            background: var(--success-green);
            border-color: var(--success-green);
            color: white;
        }

        .vote-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Submit Section */
        .submit-section {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: var(--shadow-custom);
            margin-bottom: 2rem;
        }

        .btn-submit-vote {
            background: linear-gradient(135deg, var(--success-green) 0%, #059669 100%);
            border: none;
            padding: 1rem 2rem;
            border-radius: 12px;
            font-weight: 700;
            color: white;
            font-size: 1.1rem;
            transition: all 0.3s;
        }

        .btn-submit-vote:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3);
        }

        .btn-submit-vote:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            text-align: center;
        }

        .selected-candidate-preview {
            background: #f1f5f9;
            border-radius: 10px;
            padding: 1.5rem;
            margin: 1rem 0;
        }

        .preview-photo {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 1rem;
            display: block;
            border: 3px solid var(--success-green);
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            background: white;
            border-radius: 15px;
            box-shadow: var(--shadow-custom);
        }

        .modal-content {
            border-radius: 15px;
            border: none;
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
            color: white;
            border-radius: 15px 15px 0 0;
        }

        @media (max-width: 768px) {
            .candidates-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner-border text-primary mb-3" role="status"></div>
            <h5>Memproses voting Anda...</h5>
        </div>
    </div>

    <div class="voting-header">
        <div class="header-content">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h3 class="mb-1 fw-bold">
                        <i class="bi bi-box-seam-fill me-2"></i>
                        Voting Dashboard Anggota
                    </h3>
                    <p class="mb-0 opacity-75">Gunakan hak suara Anda untuk masa depan EEPROM</p>
                </div>
                <button class="btn btn-light" onclick="logout()">
                    <i class="bi bi-box-arrow-right me-2"></i> Keluar
                </button>
            </div>

            <div class="user-info-card">
                <div class="d-flex align-items-center mb-2">
                    <i class="bi bi-person-circle fs-4 me-2"></i>
                    <h6 class="mb-0 fw-bold">Informasi Voter Anggota</h6>
                </div>
                <div class="d-flex flex-wrap">
                    <span class="user-badge">
                        <i class="bi bi-person-fill"></i>
                        <span id="voterName">-</span>
                    </span>
                    <span class="user-badge">
                        <i class="bi bi-card-text"></i>
                        NIM: <span id="voterNim">-</span>
                    </span>
                    <span class="user-badge">
                        <i class="bi bi-diagram-3-fill"></i>
                        <span id="voterDivisi">-</span>
                    </span>
                    <span class="user-badge">
                        <i class="bi bi-award-fill"></i>
                        <span id="voterJabatan">-</span>
                    </span>
                </div>
            </div>
        </div>
    </div>

    <div class="voting-container">
        <div id="alertBox" class="alert alert-custom"></div>

        <div class="voting-status-card">
            <h5 class="fw-bold mb-3">
                <i class="bi bi-clipboard-check me-2"></i>
                Status Voting
            </h5>
            <div class="status-indicator" id="votingStatus">
                <div class="status-icon">
                    <i class="bi bi-hourglass-split"></i>
                </div>
                <div>
                    <h6 class="mb-1 fw-bold">Belum Memilih</h6>
                    <p class="mb-0 text-muted small">Silakan pilih kandidat terbaik Anda</p>
                </div>
            </div>
        </div>

        <div class="mb-4">
            <h5 class="fw-bold mb-3">
                <i class="bi bi-people-fill me-2"></i>
                Daftar Kandidat
            </h5>
            <div class="candidates-grid" id="candidatesGrid">
            </div>
        </div>

        <div class="submit-section">
            <div class="row align-items-center">
                <div class="col-md-8 mb-3 mb-md-0">
                    <h5 class="fw-bold mb-2">
                        <i class="bi bi-check-circle me-2"></i>
                        Kandidat Pilihan Anda
                    </h5>
                    <p class="mb-0 text-muted" id="selectedCandidateText">
                        Belum ada kandidat yang dipilih
                    </p>
                </div>
                <div class="col-md-4">
                    <div class="d-grid">
                        <button class="btn btn-submit-vote" id="submitVoteBtn" onclick="confirmSubmitVote()" disabled>
                            <i class="bi bi-send-fill me-2"></i>
                            Kirim Suara
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        Konfirmasi Vote
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="bi bi-info-circle-fill me-2"></i>
                        <strong>Perhatian!</strong> Pilihan Anda bersifat permanen dan tidak dapat diubah kembali.
                    </div>
                    <div class="selected-candidate-preview" id="candidatePreview"></div>
                    <p class="mb-0 text-center">Apakah Anda yakin ingin mengirim suara ini?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-2"></i>Batal
                    </button>
                    <button type="button" class="btn btn-primary" onclick="submitVote()">
                        <i class="bi bi-check-circle me-2"></i>Ya, Kirim Suara
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../../../js/config/supabase-config.js"></script>
    <!-- Temporary disable auth-helper to prevent unwanted redirects -->
    <!-- <script src="../../../js/auth/auth-helper.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let selectedCandidateId = null;
        let selectedCandidateData = null;
        let currentElectionId = null;
        let hasVoted = false;

        window.addEventListener('DOMContentLoaded', async function () {
            // Check Session Anggota
            const nama = localStorage.getItem('namaLengkap');
            const nim = localStorage.getItem('nim');

            if (!nama) {
                showAlert('Akses tidak valid. Silakan login kembali.', 'danger');
                setTimeout(() => {
                    window.location.href = '../../auth/anggota/login-anggota.html';
                }, 2000);
                return;
            }

            document.getElementById('voterName').textContent = nama;
            document.getElementById('voterNim').textContent = nim || '-';
            document.getElementById('voterDivisi').textContent = localStorage.getItem('divisi') || '-';
            document.getElementById('voterJabatan').textContent = localStorage.getItem('jabatan') || '-';

            await checkVotingStatus();
            await loadCandidates();
        });

        // Check voting status
        async function checkVotingStatus() {
            try {
                const currentNim = localStorage.getItem('nim');

                // Get active election
                const { data: election, error: electionError } = await supabaseClient
                    .from('elections')
                    .select('id')
                    .eq('is_active', true)
                    .single();

                console.log('Election check:', { election, electionError });

                if (electionError || !election) {
                    console.error('No active election found');
                    return; // Jangan tampilkan alert, biarkan silent
                }

                currentElectionId = election.id;
                console.log('Active election ID:', currentElectionId);

                // Get current IP address and user agent
                const currentIP = await getIPAddress();
                const currentUserAgent = navigator.userAgent;

                console.log('Current voter info:', { currentNim, currentIP, currentUserAgent });

                // Check if anggota has voted - using voter_identifier (NIM)
                const { data: voteData, error: voteError } = await supabaseClient
                    .from('votes')
                    .select('*')
                    .eq('voter_role', 'anggota')
                    .eq('election_id', currentElectionId)
                    .eq('voter_identifier', currentNim); // Cek berdasarkan NIM

                console.log('Existing votes check:', { voteData, voteError });

                // If found vote with same NIM, user has voted
                if (voteData && voteData.length > 0) {
                    hasVoted = true;
                    updateVotingStatusUI(true);
                    showAlert('Anda sudah melakukan voting sebelumnya. Terima kasih atas partisipasi Anda!', 'info');
                }
            } catch (error) {
                console.error('Error checking voting status:', error);
                // Jangan tampilkan alert error, biarkan silent
            }
        }

        // Get IP Address
        async function getIPAddress() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                console.error('Error getting IP:', error);
                return 'unknown';
            }
        }

        // Update voting status UI
        function updateVotingStatusUI(voted) {
            const statusIndicator = document.getElementById('votingStatus');

            if (voted) {
                statusIndicator.innerHTML = `
                    <div class="status-icon" style="background: var(--success-green);">
                        <i class="bi bi-check-circle-fill"></i>
                    </div>
                    <div>
                        <h6 class="mb-1 fw-bold text-success">Sudah Voting</h6>
                        <p class="mb-0 text-muted small">Terima kasih atas partisipasi Anda!</p>
                    </div>
                `;
            }
        }

        // Load candidates
        async function loadCandidates() {
            try {
                if (!currentElectionId) {
                    console.error('No active election ID');
                    showEmptyState();
                    return;
                }

                console.log('Loading candidates for election:', currentElectionId);

                const { data: candidates, error } = await supabaseClient
                    .from('candidates')
                    .select('*')
                    .eq('election_id', currentElectionId)
                    .order('candidate_number', { ascending: true });

                console.log('Candidates loaded:', { candidates, error });

                if (error) {
                    console.error('Error loading candidates:', error);
                    showEmptyState();
                    return;
                }

                if (!candidates || candidates.length === 0) {
                    showEmptyState();
                    return;
                }

                renderCandidates(candidates);
            } catch (error) {
                console.error('Error:', error);
                showEmptyState();
            }
        }

        // Render candidates
        function renderCandidates(candidates) {
            const grid = document.getElementById('candidatesGrid');
            grid.innerHTML = candidates.map(c => `
                <div class="candidate-card" data-candidate-id="${c.id}">
                    <div class="candidate-header">
                        <div class="candidate-number">No. ${c.candidate_number}</div>
                        <div class="candidate-position">${c.position || 'Kandidat'}</div>
                    </div>
                    <div class="candidate-photo">
                        ${c.photo_url ? `<img src="${c.photo_url}" alt="${c.name}">` : '<div class="no-photo"><i class="bi bi-person-circle"></i></div>'}
                    </div>
                    <div class="candidate-body">
                        <h5 class="candidate-name">${c.name}</h5>
                        <button class="vote-button" onclick="selectCandidate('${c.id}', '${c.name.replace(/'/g, "\\'")}', '${c.photo_url || ''}', ${c.candidate_number})" ${hasVoted ? 'disabled' : ''}>
                            <i class="bi bi-hand-thumbs-up-fill me-2"></i>
                            ${hasVoted ? 'Sudah Voting' : 'Pilih Kandidat'}
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Select candidate
        function selectCandidate(id, name, photo, num) {
            if (hasVoted) return;

            selectedCandidateId = id;
            selectedCandidateData = { name, photo, num };

            document.querySelectorAll('.candidate-card').forEach(c => c.classList.remove('selected'));
            document.querySelector(`[data-candidate-id="${id}"]`).classList.add('selected');

            document.getElementById('selectedCandidateText').innerHTML = `
                <i class="bi bi-check-circle-fill text-success me-2"></i>
                <strong>No. ${num} - ${name}</strong>
            `;

            document.getElementById('submitVoteBtn').disabled = false;

            const statusIndicator = document.getElementById('votingStatus');
            statusIndicator.innerHTML = `
                <div class="status-icon" style="background: var(--accent-orange);">
                    <i class="bi bi-hand-index-thumb"></i>
                </div>
                <div>
                    <h6 class="mb-1 fw-bold" style="color: var(--accent-orange);">Kandidat Dipilih</h6>
                    <p class="mb-0 text-muted small">Klik "Kirim Suara" untuk mengirim pilihan Anda</p>
                </div>
            `;
        }

        // Confirm submit vote
        function confirmSubmitVote() {
            if (!selectedCandidateId || hasVoted) return;

            const preview = document.getElementById('candidatePreview');
            const photoHtml = selectedCandidateData.photo
                ? `<img src="${selectedCandidateData.photo}" alt="${selectedCandidateData.name}" class="preview-photo">`
                : `<div class="preview-photo" style="background: #e2e8f0; display: flex; align-items: center; justify-content: center; color: #94a3b8;">
                    <i class="bi bi-person-circle" style="font-size: 3rem;"></i>
                </div>`;

            preview.innerHTML = `
                ${photoHtml}
                <h5 class="text-center fw-bold mb-2">No. ${selectedCandidateData.num}</h5>
                <h4 class="text-center fw-bold text-primary">${selectedCandidateData.name}</h4>
            `;

            new bootstrap.Modal(document.getElementById('confirmModal')).show();
        }

        // Submit vote
        async function submitVote() {
            if (!selectedCandidateId || !currentElectionId || hasVoted) return;

            // Hide modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('confirmModal'));
            modal.hide();

            // Show loading
            document.getElementById('loadingOverlay').style.display = 'flex';

            try {
                // Get voter info
                const currentNim = localStorage.getItem('nim');
                const ipAddress = await getIPAddress();
                const userAgent = navigator.userAgent;

                console.log('Submitting vote with data:', {
                    election_id: currentElectionId,
                    candidate_id: selectedCandidateId,
                    voter_role: 'anggota',
                    voter_identifier: currentNim,
                    voted_at: new Date().toISOString(),
                    ip_address: ipAddress,
                    user_agent: userAgent
                });

                // Insert vote to votes table with voter_identifier (NIM)
                const { data: voteData, error: voteError } = await supabaseClient
                    .from('votes')
                    .insert([{
                        election_id: currentElectionId,
                        candidate_id: selectedCandidateId,
                        voter_role: 'anggota',
                        voter_identifier: currentNim, // Simpan NIM sebagai identifier
                        voted_at: new Date().toISOString(),
                        ip_address: ipAddress,
                        user_agent: userAgent
                    }])
                    .select();

                if (voteError) {
                    console.error('Vote error details:', voteError);
                    throw voteError;
                }

                console.log('Vote submitted successfully:', voteData);

                // Success - redirect to success page
                hasVoted = true;

                // Store vote info for success page
                localStorage.setItem('voteSuccess', 'true');
                localStorage.setItem('votedCandidate', selectedCandidateData.name);
                localStorage.setItem('votedCandidateNumber', selectedCandidateData.num);

                // Redirect to success page
                setTimeout(() => {
                    window.location.href = 'vote-success-anggota.html';
                }, 1000);

            } catch (error) {
                console.error('Error submitting vote:', error);
                console.error('Error details:', {
                    message: error.message,
                    hint: error.hint,
                    details: error.details,
                    code: error.code
                });

                document.getElementById('loadingOverlay').style.display = 'none';

                let errorMessage = 'Terjadi kesalahan saat mengirim vote. Silakan coba lagi.';
                if (error.message) {
                    errorMessage += ' Detail: ' + error.message;
                }

                showAlert(errorMessage, 'danger');
            }
        }

        // Show empty state
        function showEmptyState() {
            const grid = document.getElementById('candidatesGrid');
            grid.innerHTML = `
                <div class="empty-state" style="grid-column: 1/-1;">
                    <i class="bi bi-inbox" style="font-size: 5rem; color: #cbd5e1;"></i>
                    <h5 class="fw-bold">Belum Ada Kandidat</h5>
                    <p class="text-muted">Kandidat belum tersedia untuk pemilihan ini</p>
                </div>
            `;
        }

        // Show alert
        function showAlert(message, type = 'info') {
            const alertBox = document.getElementById('alertBox');
            const iconMap = {
                success: 'check-circle',
                danger: 'x-circle',
                warning: 'exclamation-triangle',
                info: 'info-circle'
            };

            alertBox.className = `alert alert-${type} alert-custom`;
            alertBox.style.display = 'block';
            alertBox.innerHTML = `
                <i class="bi bi-${iconMap[type]}-fill me-2"></i>
                ${message}
            `;

            setTimeout(() => {
                alertBox.style.display = 'none';
            }, 5000);
        }

        // Logout
        function logout() {
            if (confirm('Keluar?')) {
                localStorage.clear();
                window.location.href = '../../auth/anggota/login-anggota.html';
            }
        }
    </script>
</body>

</html>