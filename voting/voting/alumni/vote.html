<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voting Dashboard Alumni - EEPROM POLINEMA</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="icon" href="/images/eeprom_logo.png" type="image/png">
    <style>
        :root {
            --primary-blue: #1A237E;
            --secondary-blue: #3F51B5;
            --accent-orange: #FF5722;
            --light-gray: #F8F9FA;
            --medium-gray: #E8EAF6;
            --dark-text: #212529;
            --soft-text: #495057;
            --shadow-custom: 0 10px 30px rgba(0, 0, 0, 0.1);
            --success-green: #10b981;
        }

        * {
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background-color: var(--medium-gray);
            min-height: 100vh;
            padding: 0;
            margin: 0;
        }

        /* Header Section */
        .voting-header {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
            color: white;
            padding: 1.5rem 0;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-custom);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }

        .header-title {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .header-subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .btn-logout {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            border-radius: 8px;
        }

        .user-info-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 1rem;
            backdrop-filter: blur(10px);
            margin-top: 1rem;
        }

        .user-info-title {
            font-size: 0.95rem;
            margin-bottom: 0.75rem;
        }

        .user-badge {
            background: white;
            color: var(--primary-blue);
            display: inline-flex;
            align-items: center;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            margin: 0.25rem;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .user-badge i {
            margin-right: 0.4rem;
            font-size: 0.9rem;
        }

        /* Main Container */
        .voting-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px 2rem;
        }

        /* Alert Box */
        .alert-custom {
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            font-size: 0.9rem;
        }

        /* Voting Status Card */
        .voting-status-card {
            background: white;
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-custom);
        }

        .status-title {
            font-size: 1.1rem;
            margin-bottom: 1rem;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: #f1f5f9;
            border-radius: 10px;
        }

        .status-icon {
            width: 45px;
            height: 45px;
            background: var(--success-green);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.3rem;
            flex-shrink: 0;
        }

        .status-text h6 {
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }

        .status-text p {
            font-size: 0.85rem;
            margin-bottom: 0;
        }

        /* Candidate Cards */
        .section-title {
            font-size: 1.1rem;
            margin-bottom: 1rem;
        }

        .candidates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .candidate-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow-custom);
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }

        .candidate-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.15);
        }

        .candidate-card.selected {
            border-color: var(--success-green);
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
        }

        .candidate-header {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
            color: white;
            padding: 0.875rem;
            text-align: center;
        }

        .candidate-number {
            font-size: 1.75rem;
            font-weight: 800;
            margin-bottom: 0.25rem;
        }

        .candidate-position {
            font-size: 0.85rem;
            font-weight: 600;
            opacity: 0.9;
        }

        .candidate-photo {
            width: 100%;
            height: 500px;
            background: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        .candidate-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .candidate-photo.no-photo {
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
            color: #94a3b8;
            font-size: 3.5rem;
        }

        .candidate-body {
            padding: 1.25rem;
        }

        .candidate-name {
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--dark-text);
            margin-bottom: 0.5rem;
            line-height: 1.3;
        }

        .candidate-position-text {
            color: var(--secondary-blue);
            font-weight: 600;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .btn-detail {
            width: 100%;
            padding: 0.75rem;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            background: white;
            color: var(--secondary-blue);
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s;
            margin-bottom: 0.75rem;
        }

        .btn-detail:hover {
            background: #f1f5f9;
            border-color: var(--secondary-blue);
        }

        .vote-button {
            width: 100%;
            padding: 0.875rem;
            border-radius: 8px;
            border: 2px solid var(--secondary-blue);
            background: white;
            color: var(--secondary-blue);
            font-weight: 700;
            font-size: 0.95rem;
            transition: all 0.3s;
        }

        .vote-button:hover:not(:disabled) {
            background: var(--secondary-blue);
            color: white;
            transform: translateY(-2px);
        }

        .vote-button.selected {
            background: var(--success-green);
            border-color: var(--success-green);
            color: white;
        }

        .vote-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Submit Section */
        .submit-section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow-custom);
            margin-bottom: 1.5rem;
        }

        .submit-title {
            font-size: 1.05rem;
            margin-bottom: 0.5rem;
        }

        .selected-text {
            font-size: 0.9rem;
        }

        .btn-submit-vote {
            background: linear-gradient(135deg, var(--success-green) 0%, #059669 100%);
            border: none;
            padding: 1rem 2rem;
            border-radius: 10px;
            font-weight: 700;
            color: white;
            font-size: 1rem;
            transition: all 0.3s;
            width: 100%;
        }

        .btn-submit-vote:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
        }

        .btn-submit-vote:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            text-align: center;
            max-width: 90%;
        }

        .selected-candidate-preview {
            background: #f1f5f9;
            border-radius: 10px;
            padding: 1.5rem;
            margin: 1rem 0;
        }

        .preview-photo {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 1rem;
            display: block;
            border: 3px solid var(--success-green);
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1.5rem;
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow-custom);
        }

        .empty-state i {
            font-size: 4rem;
            color: #cbd5e1;
            margin-bottom: 1rem;
        }

        /* Modal Styling */
        .modal-content {
            border-radius: 12px;
            border: none;
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
            color: white;
            border-radius: 12px 12px 0 0;
            padding: 1.25rem;
        }

        .modal-title {
            font-size: 1.1rem;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
        }

        /* Vision Mission Detail Modal */
        .detail-section {
            margin-bottom: 1.5rem;
        }

        .detail-section h6 {
            color: var(--primary-blue);
            font-weight: 700;
            font-size: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .detail-section p,
        .detail-section ul,
        .detail-section ol {
            font-size: 0.9rem;
            line-height: 1.8;
            color: var(--soft-text);
        }

        .detail-section ol {
            padding-left: 1.5rem;
            margin-bottom: 0;
        }

        .detail-section li {
            margin-bottom: 0.75rem;
            padding-left: 0.5rem;
        }

        .candidate-detail-header {
            text-align: center;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 1.5rem;
        }

        .candidate-detail-photo {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 1rem;
            display: block;
            border: 4px solid var(--secondary-blue);
        }

        .candidate-detail-photo.no-photo {
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #94a3b8;
            font-size: 3rem;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .voting-header {
                padding: 1rem 0;
            }

            .header-title {
                font-size: 1.25rem;
            }

            .header-subtitle {
                font-size: 0.85rem;
            }

            .btn-logout {
                padding: 0.4rem 0.8rem;
                font-size: 0.85rem;
            }

            .user-badge {
                font-size: 0.75rem;
                padding: 0.35rem 0.7rem;
                margin: 0.2rem;
            }

            .candidates-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .candidate-photo {
                height: 500px;
            }

            .submit-section {
                padding: 1.25rem;
            }

            .btn-submit-vote {
                font-size: 0.95rem;
                padding: 0.875rem 1.5rem;
            }

            .modal-body {
                padding: 1.25rem;
            }

            .candidate-detail-photo {
                width: 100%;
                height: 400px;
                border-radius: 12px;
            }
        }

        @media (max-width: 576px) {
            .voting-container {
                padding: 0 10px 1.5rem;
            }

            .section-title,
            .status-title,
            .submit-title {
                font-size: 1rem;
            }

            .candidate-name {
                font-size: 1.05rem;
            }

            .status-icon {
                width: 40px;
                height: 40px;
                font-size: 1.1rem;
            }

            .status-text h6 {
                font-size: 0.95rem;
            }

            .status-text p {
                font-size: 0.8rem;
            }
        }

        @media (min-width: 992px) {
            .candidates-grid {
                grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            }
        }
    </style>
</head>

<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner-border text-primary mb-3" role="status"></div>
            <h5>Memproses voting Anda...</h5>
        </div>
    </div>

    <div class="voting-header">
        <div class="header-content">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <div class="flex-grow-1">
                    <h3 class="mb-1 fw-bold header-title">
                        <i class="bi bi-trophy-fill me-2"></i>
                        Voting Dashboard Alumni
                    </h3>
                    <p class="mb-0 opacity-75 header-subtitle">Gunakan hak suara Anda untuk masa depan EEPROM</p>
                </div>
                <button class="btn btn-light btn-logout" onclick="logout()">
                    <i class="bi bi-box-arrow-right me-1"></i> Keluar
                </button>
            </div>

            <div class="user-info-card">
                <div class="d-flex align-items-center mb-2">
                    <i class="bi bi-person-circle fs-5 me-2"></i>
                    <h6 class="mb-0 fw-bold user-info-title">Informasi Voter</h6>
                </div>
                <div class="d-flex flex-wrap">
                    <span class="user-badge">
                        <i class="bi bi-person-fill"></i>
                        <span id="voterName">-</span>
                    </span>
                    <span class="user-badge">
                        <i class="bi bi-mortarboard-fill"></i>
                        Generasi <span id="voterGen">-</span>
                    </span>
                </div>
            </div>
        </div>
    </div>

    <div class="voting-container">
        <div id="alertBox" class="alert alert-custom"></div>

        <div class="voting-status-card">
            <h5 class="fw-bold status-title">
                <i class="bi bi-clipboard-check me-2"></i>
                Status Voting
            </h5>
            <div class="status-indicator" id="votingStatus">
                <div class="status-icon">
                    <i class="bi bi-hourglass-split"></i>
                </div>
                <div class="status-text">
                    <h6 class="mb-1 fw-bold">Belum Memilih</h6>
                    <p class="mb-0 text-muted">Silakan pilih kandidat terbaik Anda</p>
                </div>
            </div>
        </div>

        <div class="mb-4">
            <h5 class="fw-bold section-title">
                <i class="bi bi-people-fill me-2"></i>
                Daftar Kandidat
            </h5>
            <div class="candidates-grid" id="candidatesGrid">
            </div>
        </div>

        <div class="submit-section">
            <div class="row align-items-center">
                <div class="col-md-8 mb-3 mb-md-0">
                    <h5 class="fw-bold mb-2 submit-title">
                        <i class="bi bi-check-circle me-2"></i>
                        Kandidat Pilihan Anda
                    </h5>
                    <p class="mb-0 text-muted selected-text" id="selectedCandidateText">
                        Belum ada kandidat yang dipilih
                    </p>
                </div>
                <div class="col-md-4">
                    <div class="d-grid">
                        <button class="btn btn-submit-vote" id="submitVoteBtn" onclick="confirmSubmitVote()" disabled>
                            <i class="bi bi-send-fill me-2"></i>
                            Kirim Suara
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div class="modal fade" id="detailModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-info-circle-fill me-2"></i>
                        Detail Kandidat
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="detailModalBody">
                    <!-- Content will be injected here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-2"></i>Tutup
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        Konfirmasi Vote
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="bi bi-info-circle-fill me-2"></i>
                        <strong>Perhatian!</strong> Pilihan Anda bersifat permanen dan tidak dapat diubah kembali.
                    </div>
                    <div class="selected-candidate-preview" id="candidatePreview"></div>
                    <p class="mb-0 text-center">Apakah Anda yakin ingin mengirim suara ini?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-2"></i>Batal
                    </button>
                    <button type="button" class="btn btn-primary" onclick="submitVote()">
                        <i class="bi bi-check-circle me-2"></i>Ya, Kirim Suara
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../../../js/config/supabase-config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let selectedCandidateId = null;
        let selectedCandidateData = null;
        let currentElectionId = null;
        let hasVoted = false;
        let candidatesData = [];

        window.addEventListener('DOMContentLoaded', async function () {
            console.log('üîÑ Loading voting page...');

            const alumniName = localStorage.getItem('namaLengkap');
            const codeVerified = localStorage.getItem('codeVerified');

            if (!alumniName || codeVerified !== 'true') {
                console.error('‚ùå No valid session');
                showAlert('Akses tidak valid. Silakan login kembali.', 'danger');
                setTimeout(() => {
                    window.location.href = '../../auth/alumni/login-alumni.html';
                }, 2000);
                return;
            }

            // Display voter info
            document.getElementById('voterName').textContent = alumniName;
            document.getElementById('voterGen').textContent = localStorage.getItem('generasi') || '-';

            console.log('‚úÖ Session loaded for alumni:', alumniName);

            // Check voting status dan load candidates
            await checkVotingStatus();
            await loadCandidates();
        });

        // Check voting status
        async function checkVotingStatus() {
            try {
                console.log('üîç Checking voting status...');

                // Get active election
                const { data: election, error: electionError } = await supabaseClient
                    .from('elections')
                    .select('id')
                    .eq('is_active', true)
                    .single();

                if (electionError || !election) {
                    console.warn('‚ö†Ô∏è No active election');
                    showAlert('Tidak ada pemilihan yang sedang aktif.', 'warning');
                    return;
                }

                currentElectionId = election.id;
                console.log('üìå Current election ID:', currentElectionId);

                const currentIP = await getIPAddress();
                const currentUserAgent = navigator.userAgent;

                console.log('üîç Checking for existing votes with IP:', currentIP);

                // Check if alumni has voted - using IP and user agent
                const { data: voteData, error: voteError } = await supabaseClient
                    .from('votes')
                    .select('ip_address, user_agent')
                    .eq('voter_role', 'alumni')
                    .eq('election_id', currentElectionId);

                console.log('üìä Vote check result:', { voteData, voteError });

                // If found vote with same IP or user agent, user has voted
                if (voteData && voteData.some(v => v.ip_address === currentIP || v.user_agent === currentUserAgent)) {
                    console.warn('‚ö†Ô∏è User already voted!');
                    hasVoted = true;
                    updateVotingStatusUI(true);
                    showAlert('Anda sudah melakukan voting sebelumnya. Terima kasih atas partisipasi Anda!', 'info');

                    // Disable all voting actions
                    disableVotingUI();
                } else {
                    console.log('‚úÖ User has not voted yet');
                }
            } catch (error) {
                console.error('‚ùå Error checking voting status:', error);
                showAlert('Gagal mengecek status voting: ' + error.message, 'danger');
            }
        }

        // Disable voting UI if already voted
        function disableVotingUI() {
            const submitBtn = document.getElementById('submitVoteBtn');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i>Sudah Voting';
            }
        }

        // Get IP Address
        async function getIPAddress() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                console.error('Error getting IP:', error);
                return 'unknown';
            }
        }

        // Update voting status UI
        function updateVotingStatusUI(voted) {
            const statusIndicator = document.getElementById('votingStatus');

            if (voted) {
                statusIndicator.innerHTML = `
                    <div class="status-icon" style="background: var(--success-green);">
                        <i class="bi bi-check-circle-fill"></i>
                    </div>
                    <div class="status-text">
                        <h6 class="mb-1 fw-bold text-success">Sudah Voting</h6>
                        <p class="mb-0 text-muted">Terima kasih atas partisipasi Anda!</p>
                    </div>
                `;
            }
        }

        // Load candidates
        async function loadCandidates() {
            try {
                if (!currentElectionId) {
                    console.error('‚ùå No election ID');
                    showEmptyState();
                    return;
                }

                console.log('üìä Loading candidates for election:', currentElectionId);

                const { data: candidates, error } = await supabaseClient
                    .from('candidates')
                    .select('*')
                    .eq('election_id', currentElectionId)
                    .order('candidate_number', { ascending: true });

                console.log('‚úÖ Candidates loaded:', { count: candidates?.length, error });

                if (error) {
                    console.error('‚ùå Error loading candidates:', error);
                    showAlert('Gagal memuat kandidat: ' + error.message, 'danger');
                    showEmptyState();
                    return;
                }

                if (!candidates || candidates.length === 0) {
                    console.warn('‚ö†Ô∏è No candidates found');
                    showEmptyState();
                    return;
                }

                candidatesData = candidates;
                renderCandidates(candidates);
            } catch (error) {
                console.error('‚ùå Error:', error);
                showAlert('Terjadi kesalahan: ' + error.message, 'danger');
                showEmptyState();
            }
        }

        // Render candidates
        function renderCandidates(candidates) {
            const grid = document.getElementById('candidatesGrid');
            grid.innerHTML = candidates.map(c => `
                <div class="candidate-card" data-candidate-id="${c.id}">
                    <div class="candidate-header">
                        <div class="candidate-number">No. ${c.candidate_number}</div>
                        <div class="candidate-position">${c.position || 'Kandidat'}</div>
                    </div>
                    <div class="candidate-photo ${!c.photo_url ? 'no-photo' : ''}">
                        ${c.photo_url ? `<img src="${c.photo_url}" alt="${c.name}">` : '<i class="bi bi-person-circle"></i>'}
                    </div>
                    <div class="candidate-body">
                        <h5 class="candidate-name">${c.name}</h5>
                        <button class="btn btn-detail" onclick="showDetail('${c.id}')">
                            <i class="bi bi-info-circle me-1"></i>
                            Lihat Visi & Misi
                        </button>
                        <button class="vote-button" onclick="selectCandidate('${c.id}', '${c.name.replace(/'/g, "\\'")}', '${c.photo_url || ''}', ${c.candidate_number})" ${hasVoted ? 'disabled' : ''}>
                            <i class="bi bi-hand-thumbs-up-fill me-2"></i>
                            ${hasVoted ? 'Sudah Voting' : 'Pilih Kandidat'}
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Format vision text as simple paragraph (no numbering, no bullets)
        function formatVision(visionText) {
            if (!visionText) return '';
            
            // Just return as paragraph with line breaks preserved
            return `<p style="margin-bottom: 0; line-height: 1.8; text-align: justify;">${visionText.replace(/\n/g, '<br>')}</p>`;
        }

        // Format mission text into numbered list (ordered list)
        function formatMission(missionText) {
            if (!missionText) return '';
            
            // Split by newline
            const lines = missionText.split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);
            
            // Remove existing numbers if present and render as ordered list
            const listItems = lines.map(item => {
                const text = item.replace(/^\d+\.\s*/, '');
                return `<li>${text}</li>`;
            }).join('');
            
            return `<ol style="padding-left: 1.5rem; margin-bottom: 0; line-height: 1.8;">${listItems}</ol>`;
        }

        // Show candidate detail
        function showDetail(candidateId) {
            const candidate = candidatesData.find(c => c.id === candidateId);
            if (!candidate) return;

            const photoHtml = candidate.photo_url
                ? `<img src="${candidate.photo_url}" alt="${candidate.name}" class="candidate-detail-photo">`
                : `<div class="candidate-detail-photo no-photo">
                    <i class="bi bi-person-circle"></i>
                </div>`;

            const visionHtml = candidate.vision
                ? `<div class="detail-section">
                    <h6><i class="bi bi-eye-fill"></i> Visi</h6>
                    ${formatVision(candidate.vision)}
                </div>`
                : '';

            const missionHtml = candidate.mission
                ? `<div class="detail-section">
                    <h6><i class="bi bi-list-check"></i> Misi</h6>
                    ${formatMission(candidate.mission)}
                </div>`
                : '';

            const detailContent = `
                <div class="candidate-detail-header">
                    ${photoHtml}
                    <h4 class="fw-bold mb-1">No. ${candidate.candidate_number}</h4>
                    <h3 class="fw-bold text-primary mb-2">${candidate.name}</h3>
                    <p class="text-muted mb-0">${candidate.position || 'Kandidat'}</p>
                </div>
                ${visionHtml}
                ${missionHtml}
                ${!candidate.vision && !candidate.mission ? '<p class="text-muted text-center py-3">Belum ada visi dan misi yang ditambahkan.</p>' : ''}
            `;

            document.getElementById('detailModalBody').innerHTML = detailContent;
            new bootstrap.Modal(document.getElementById('detailModal')).show();
        }

        // Select candidate
        function selectCandidate(id, name, photo, num) {
            if (hasVoted) {
                showAlert('Anda sudah melakukan voting!', 'warning');
                return;
            }

            selectedCandidateId = id;
            selectedCandidateData = { name, photo, num };

            document.querySelectorAll('.candidate-card').forEach(c => c.classList.remove('selected'));
            document.querySelector(`[data-candidate-id="${id}"]`).classList.add('selected');

            document.querySelectorAll('.vote-button').forEach(btn => {
                btn.classList.remove('selected');
                btn.innerHTML = '<i class="bi bi-hand-thumbs-up-fill me-2"></i>Pilih Kandidat';
            });

            const selectedButton = document.querySelector(`[data-candidate-id="${id}"] .vote-button`);
            selectedButton.classList.add('selected');
            selectedButton.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i>Kandidat Dipilih';

            document.getElementById('selectedCandidateText').innerHTML = `
                <i class="bi bi-check-circle-fill text-success me-2"></i>
                <strong>No. ${num} - ${name}</strong>
            `;

            document.getElementById('submitVoteBtn').disabled = false;

            const statusIndicator = document.getElementById('votingStatus');
            statusIndicator.innerHTML = `
                <div class="status-icon" style="background: var(--accent-orange);">
                    <i class="bi bi-hand-index-thumb"></i>
                </div>
                <div class="status-text">
                    <h6 class="mb-1 fw-bold" style="color: var(--accent-orange);">Kandidat Dipilih</h6>
                    <p class="mb-0 text-muted">Klik "Kirim Suara" untuk mengirim pilihan Anda</p>
                </div>
            `;
        }

        // Confirm submit vote
        function confirmSubmitVote() {
            if (!selectedCandidateId || hasVoted) {
                showAlert('Tidak ada kandidat yang dipilih atau Anda sudah voting!', 'warning');
                return;
            }

            const preview = document.getElementById('candidatePreview');
            const photoHtml = selectedCandidateData.photo
                ? `<img src="${selectedCandidateData.photo}" alt="${selectedCandidateData.name}" class="preview-photo">`
                : `<div class="preview-photo" style="background: #e2e8f0; display: flex; align-items: center; justify-content: center; color: #94a3b8;">
                    <i class="bi bi-person-circle" style="font-size: 3rem;"></i>
                </div>`;

            preview.innerHTML = `
                ${photoHtml}
                <h5 class="text-center fw-bold mb-2">No. ${selectedCandidateData.num}</h5>
                <h4 class="text-center fw-bold text-primary">${selectedCandidateData.name}</h4>
            `;

            new bootstrap.Modal(document.getElementById('confirmModal')).show();
        }

        // Submit vote
        async function submitVote() {
            if (!selectedCandidateId || !currentElectionId || hasVoted) {
                showAlert('Tidak dapat mengirim vote!', 'danger');
                return;
            }

            // Hide modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('confirmModal'));
            modal.hide();

            // Show loading
            document.getElementById('loadingOverlay').style.display = 'flex';

            try {
                const ipAddress = await getIPAddress();
                const userAgent = navigator.userAgent;

                console.log('üì§ Submitting vote:', {
                    election_id: currentElectionId,
                    candidate_id: selectedCandidateId,
                    voter_role: 'alumni'
                });

                // Insert vote
                const { data: voteData, error: voteError } = await supabaseClient
                    .from('votes')
                    .insert([{
                        election_id: currentElectionId,
                        candidate_id: selectedCandidateId,
                        voter_role: 'alumni',
                        voted_at: new Date().toISOString(),
                        ip_address: ipAddress,
                        user_agent: userAgent
                    }])
                    .select();

                if (voteError) {
                    console.error('‚ùå Vote error:', voteError);
                    throw voteError;
                }

                console.log('‚úÖ Vote submitted:', voteData);

                // Update candidate total_votes
                const { error: updateCandidateError } = await supabaseClient
                    .rpc('increment_candidate_votes', {
                        candidate_id: selectedCandidateId
                    });

                if (updateCandidateError) {
                    console.warn('‚ö†Ô∏è Failed to increment candidate votes:', updateCandidateError);
                }

                // Success
                hasVoted = true;

                // Store vote info for success page
                localStorage.setItem('voteSuccess', 'true');
                localStorage.setItem('votedCandidate', selectedCandidateData.name);
                localStorage.setItem('votedCandidateNumber', selectedCandidateData.num);

                // Redirect to success page
                setTimeout(() => {
                    window.location.href = 'vote-success.html';
                }, 1000);

            } catch (error) {
                console.error('‚ùå Error submitting vote:', error);
                document.getElementById('loadingOverlay').style.display = 'none';

                let errorMessage = 'Terjadi kesalahan saat mengirim vote. Silakan coba lagi.';
                if (error.message) {
                    errorMessage += ' Detail: ' + error.message;
                }

                showAlert(errorMessage, 'danger');
            }
        }

        // Show empty state
        function showEmptyState() {
            const grid = document.getElementById('candidatesGrid');
            grid.innerHTML = `
                <div class="empty-state" style="grid-column: 1/-1;">
                    <i class="bi bi-inbox"></i>
                    <h5 class="fw-bold">Belum Ada Kandidat</h5>
                    <p class="text-muted">Kandidat belum tersedia untuk pemilihan ini</p>
                </div>
            `;
        }

        // Show alert
        function showAlert(message, type = 'info') {
            const alertBox = document.getElementById('alertBox');
            const iconMap = {
                success: 'check-circle',
                danger: 'x-circle',
                warning: 'exclamation-triangle',
                info: 'info-circle'
            };

            alertBox.className = `alert alert-${type} alert-custom`;
            alertBox.style.display = 'block';
            alertBox.innerHTML = `
                <i class="bi bi-${iconMap[type]}-fill me-2"></i>
                ${message}
            `;

            setTimeout(() => {
                alertBox.style.display = 'none';
            }, 5000);
        }

        // Logout
        function logout() {
            if (confirm('Keluar dari dashboard voting?')) {
                localStorage.clear();
                window.location.href = '../../auth/alumni/login-alumni.html';
            }
        }

        // Prevent back navigation after voting
        window.addEventListener('pageshow', function (event) {
            if (hasVoted) {
                window.location.href = 'vote-success.html';
            }
        });
    </script>
</body>

</html>