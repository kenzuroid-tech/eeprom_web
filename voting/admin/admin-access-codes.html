<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kelola Kode Akses - EEPROM Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="icon" href="/images/eeprom_logo.png" type="image/png">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8f9fa;
        }
        .code-badge {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            padding: 0.5rem 0.75rem;
        }
        .search-box {
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="container-fluid p-4">
        <nav class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <a href="admin-voting-dashboard.html" class="btn btn-sm btn-light border me-3">
                    <i class="bi bi-arrow-left"></i>
                </a>
                <span class="h4 fw-bold">Kelola Kode Akses</span>
            </div>
            <div>
                <button class="btn btn-success me-2" onclick="showGenerateModal()">
                    <i class="bi bi-plus-circle me-2"></i>Generate Kode
                </button>
                <button class="btn btn-primary me-2" onclick="exportToExcel()">
                    <i class="bi bi-file-earmark-excel me-2"></i>Export Excel
                </button>
            </div>
        </nav>

        <!-- Election Selector -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <label class="form-label fw-bold mb-2">Pilih Pemilihan</label>
                        <select class="form-select" id="electionSelector" onchange="loadAccessCodes()">
                            <option value="">Memuat pemilihan...</option>
                        </select>
                        <div class="mt-2" id="electionInfo">
                            <small class="text-muted">
                                <i class="bi bi-info-circle me-1"></i>
                                <span id="electionDetails">Pilih pemilihan untuk melihat kode akses</span>
                            </small>
                        </div>
                    </div>
                    <div class="col-md-4 text-md-end mt-3 mt-md-0">
                        <div class="mb-2">
                            <span class="badge bg-primary px-3 py-2">Total: <span id="totalCodes">0</span></span>
                        </div>
                        <div>
                            <span class="badge bg-success px-2 py-1 me-1">Anggota: <span id="memberCount">0</span></span>
                            <span class="badge bg-secondary px-2 py-1 me-1">Alumni: <span id="alumniCount">0</span></span>
                            <span class="badge bg-info px-2 py-1">Delegasi: <span id="delegasiCount">0</span></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body">
                <input type="text" class="form-control search-box" id="searchInput" 
                       placeholder="Cari berdasarkan kode, nama, atau identitas..." onkeyup="filterCodes()">
            </div>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs mb-4">
            <li class="nav-item">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-all">
                    Semua (<span id="allTabCount">0</span>)
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-member">
                    Anggota (<span id="memberTabCount">0</span>)
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-alumni">
                    Alumni (<span id="alumniTabCount">0</span>)
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-delegasi">
                    Delegasi (<span id="delegasiTabCount">0</span>)
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content">
            <div class="tab-pane fade show active" id="tab-all">
                <div id="allTable">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3 text-muted">Memuat data...</p>
                    </div>
                </div>
            </div>
            <div class="tab-pane fade" id="tab-member">
                <div id="memberTable">Loading...</div>
            </div>
            <div class="tab-pane fade" id="tab-alumni">
                <div id="alumniTable">Loading...</div>
            </div>
            <div class="tab-pane fade" id="tab-delegasi">
                <div id="delegasiTable">Loading...</div>
            </div>
        </div>
    </div>

    <!-- Generate Modal -->
    <div class="modal fade" id="generateModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Generate Kode Akses</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Pilih Tipe User</label>
                        <select class="form-select" id="userTypeSelect" onchange="toggleInputFields()">
                            <option value="">-- Pilih Tipe --</option>
                            <option value="anggota">Anggota (Member Aktif)</option>
                            <option value="alumni">Alumni</option>
                            <option value="delegasi">Delegasi</option>
                        </select>
                    </div>

                    <!-- For Delegasi Manual Input -->
                    <div id="delegasiInputs" style="display: none;">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            Input manual untuk delegasi (satu per satu)
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Nama Lengkap</label>
                            <input type="text" class="form-control" id="delegasiName" placeholder="Nama lengkap delegasi">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">NIM (Opsional)</label>
                            <input type="text" class="form-control" id="delegasiNim" placeholder="NIM jika ada">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Asal Instansi</label>
                            <input type="text" class="form-control" id="delegasiInstansi" placeholder="Nama instansi/organisasi" required>
                        </div>
                    </div>

                    <!-- Info for Anggota/Alumni -->
                    <div id="autoGenerateInfo" style="display: none;">
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle me-2"></i>
                            Kode akan digenerate otomatis untuk semua <span id="userTypeLabel"></span> dari database
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-success" onclick="generateCodes()">
                        <i class="bi bi-lightning-fill me-2"></i>Generate
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="../../js/config/supabase-config.js"></script>
    <script src="../../js/auth/auth-helper.js"></script>
    <script src="../../js/auth/admin-guard.js"></script>

    <script>
        let allCodes = [];
        let filteredCodes = [];
        let selectedElectionId = null;
        let currentElection = null;

        async function loadPage() {
            console.log('üîÑ Loading access codes page...');

            try {
                // Load elections
                console.log('üìä Fetching elections...');
                const { data: elections, error } = await supabaseClient
                    .from('elections')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('‚ùå Error fetching elections:', error);
                    throw error;
                }

                console.log('‚úÖ Elections loaded:', elections);

                if (!elections || elections.length === 0) {
                    document.getElementById('electionSelector').innerHTML = 
                        '<option value="">Belum ada pemilihan</option>';
                    document.getElementById('allTable').innerHTML = `
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Belum ada pemilihan yang dibuat. 
                            <a href="admin-create-election.html" class="alert-link">Buat pemilihan baru</a>
                        </div>
                    `;
                    return;
                }

                const selector = document.getElementById('electionSelector');
                selector.innerHTML = elections.map(e => {
                    const status = e.is_active ? 'Aktif' : 'Tidak Aktif';
                    const startDate = new Date(e.start_date).toLocaleDateString('id-ID', {
                        day: '2-digit',
                        month: 'short',
                        year: 'numeric'
                    });
                    const endDate = new Date(e.end_date).toLocaleDateString('id-ID', {
                        day: '2-digit',
                        month: 'short',
                        year: 'numeric'
                    });
                    
                    return `<option value="${e.id}" ${e.is_active ? 'selected' : ''}>
                        ${e.title} (${status}) - ${startDate} s/d ${endDate}
                    </option>`;
                }).join('');

                // Pilih election yang aktif atau yang pertama
                const activeElection = elections.find(e => e.is_active);
                selectedElectionId = activeElection ? activeElection.id : elections[0].id;
                currentElection = elections.find(e => e.id === selectedElectionId);
                
                console.log('üìå Selected election:', currentElection);

                // Load access codes untuk election terpilih
                await loadAccessCodes();

            } catch (error) {
                console.error('‚ùå Error loading page:', error);
                alert('Gagal memuat halaman: ' + error.message);
                document.getElementById('allTable').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-x-circle me-2"></i>
                        Error: ${error.message}
                    </div>
                `;
            }
        }

        async function loadAccessCodes() {
            selectedElectionId = document.getElementById('electionSelector').value;
            
            if (!selectedElectionId) {
                console.warn('‚ö†Ô∏è No election selected');
                return;
            }

            console.log('üìä Loading access codes for election:', selectedElectionId);

            try {
                // Load election detail
                const { data: election, error: electionError } = await supabaseClient
                    .from('elections')
                    .select('*')
                    .eq('id', selectedElectionId)
                    .single();

                if (electionError) {
                    console.error('‚ùå Error loading election:', electionError);
                    throw electionError;
                }
                
                currentElection = election;
                console.log('‚úÖ Election loaded:', election);

                // Load access codes
                const { data: codes, error: codesError } = await supabaseClient
                    .from('access_codes')
                    .select('*')
                    .eq('election_id', selectedElectionId)
                    .order('created_at', { ascending: false });

                if (codesError) {
                    console.error('‚ùå Error loading codes:', codesError);
                    throw codesError;
                }

                console.log('‚úÖ Access codes loaded:', codes);

                allCodes = codes || [];
                filteredCodes = allCodes;

                updateStatistics();
                displayTables();

            } catch (error) {
                console.error('‚ùå Error loading access codes:', error);
                alert('Gagal memuat kode akses: ' + error.message);
                
                document.getElementById('allTable').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-x-circle me-2"></i>
                        Error: ${error.message}
                    </div>
                `;
            }
        }

        function updateStatistics() {
            const memberCodes = allCodes.filter(c => c.user_type === 'anggota' || c.role_type === 'anggota');
            const alumniCodes = allCodes.filter(c => c.user_type === 'alumni' || c.role_type === 'alumni');
            const delegasiCodes = allCodes.filter(c => c.user_type === 'delegasi' || c.role_type === 'delegasi');

            document.getElementById('totalCodes').textContent = allCodes.length;
            document.getElementById('memberCount').textContent = memberCodes.length;
            document.getElementById('alumniCount').textContent = alumniCodes.length;
            document.getElementById('delegasiCount').textContent = delegasiCodes.length;

            document.getElementById('allTabCount').textContent = allCodes.length;
            document.getElementById('memberTabCount').textContent = memberCodes.length;
            document.getElementById('alumniTabCount').textContent = alumniCodes.length;
            document.getElementById('delegasiTabCount').textContent = delegasiCodes.length;

            // Update election details info
            if (currentElection) {
                const allowedTypes = [];
                if (currentElection.allow_anggota) allowedTypes.push('Anggota');
                if (currentElection.allow_alumni) allowedTypes.push('Alumni');
                if (currentElection.allow_delegasi) allowedTypes.push('Delegasi');

                document.getElementById('electionDetails').innerHTML = `
                    Tipe yang diizinkan: <strong>${allowedTypes.join(', ') || 'Tidak ada'}</strong> | 
                    Status: <span class="badge bg-${currentElection.is_active ? 'success' : 'secondary'} badge-sm">
                        ${currentElection.is_active ? 'Aktif' : 'Tidak Aktif'}
                    </span>
                `;
            }
        }

        function displayTables() {
            const memberCodes = filteredCodes.filter(c => c.user_type === 'anggota' || c.role_type === 'anggota');
            const alumniCodes = filteredCodes.filter(c => c.user_type === 'alumni' || c.role_type === 'alumni');
            const delegasiCodes = filteredCodes.filter(c => c.user_type === 'delegasi' || c.role_type === 'delegasi');

            document.getElementById('allTable').innerHTML = renderTable(filteredCodes);
            document.getElementById('memberTable').innerHTML = renderTable(memberCodes);
            document.getElementById('alumniTable').innerHTML = renderTable(alumniCodes);
            document.getElementById('delegasiTable').innerHTML = renderTable(delegasiCodes);
        }

        function renderTable(codes) {
            if (codes.length === 0) {
                return `
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        Tidak ada kode untuk ditampilkan. Klik tombol "Generate Kode" untuk membuat kode akses baru.
                    </div>
                `;
            }

            const rows = codes.map(c => {
                let metadata = {};
                try {
                    metadata = c.voter_metadata ? JSON.parse(c.voter_metadata) : {};
                } catch (e) {
                    console.error('Error parsing metadata:', e);
                }

                const userType = c.user_type || c.role_type || 'unknown';
                
                return `
                    <tr class="${c.is_used ? 'table-light' : ''}">
                        <td>
                            <code class="code-badge bg-primary bg-opacity-10 text-primary rounded">${c.code}</code>
                            <button class="btn btn-sm btn-link" onclick="copyCode('${c.code}')" title="Copy kode">
                                <i class="bi bi-clipboard"></i>
                            </button>
                        </td>
                        <td>
                            <div class="fw-bold">${c.voter_name || '-'}</div>
                            <small class="text-muted">${c.voter_identifier || '-'}</small>
                        </td>
                        <td>
                            <span class="badge bg-${userType === 'anggota' ? 'success' : userType === 'alumni' ? 'secondary' : 'info'}">
                                ${userType.charAt(0).toUpperCase() + userType.slice(1)}
                            </span>
                        </td>
                        <td>
                            ${userType === 'delegasi' 
                                ? (c.is_verified 
                                    ? '<span class="badge bg-success"><i class="bi bi-check-circle"></i> Verified</span>'
                                    : '<span class="badge bg-warning"><i class="bi bi-clock"></i> Pending</span>')
                                : '-'
                            }
                        </td>
                        <td>
                            ${c.is_used 
                                ? `<span class="badge bg-success">Terpakai</span><br>
                                   <small class="text-muted">${formatDateTime(c.voted_at)}</small>` 
                                : '<span class="badge bg-secondary">Belum Terpakai</span>'}
                        </td>
                        <td>
                            ${metadata.instansi ? `<small>${metadata.instansi}</small>` : 
                              metadata.generasi ? `<small>Gen ${metadata.generasi}</small>` : '-'}
                        </td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="deleteCode('${c.id}')" title="Hapus kode">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            return `
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>Kode Akses</th>
                                        <th>Nama & Identitas</th>
                                        <th>Tipe</th>
                                        <th>Verifikasi</th>
                                        <th>Status</th>
                                        <th>Info</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody>${rows}</tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function filterCodes() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            if (!searchTerm) {
                filteredCodes = allCodes;
            } else {
                filteredCodes = allCodes.filter(c => 
                    (c.code && c.code.toLowerCase().includes(searchTerm)) ||
                    (c.voter_name && c.voter_name.toLowerCase().includes(searchTerm)) ||
                    (c.voter_identifier && c.voter_identifier.toLowerCase().includes(searchTerm))
                );
            }

            displayTables();
        }

        function showGenerateModal() {
            if (!currentElection) {
                alert('Pilih pemilihan terlebih dahulu!');
                return;
            }

            // Update dropdown options based on election settings
            const userTypeSelect = document.getElementById('userTypeSelect');
            let options = '<option value="">-- Pilih Tipe --</option>';
            
            if (currentElection.allow_anggota) {
                options += '<option value="anggota">Anggota (Member Aktif)</option>';
            }
            if (currentElection.allow_alumni) {
                options += '<option value="alumni">Alumni</option>';
            }
            if (currentElection.allow_delegasi) {
                options += '<option value="delegasi">Delegasi</option>';
            }

            userTypeSelect.innerHTML = options;

            const allowedTypes = [];
            if (currentElection.allow_anggota) allowedTypes.push('Anggota');
            if (currentElection.allow_alumni) allowedTypes.push('Alumni');
            if (currentElection.allow_delegasi) allowedTypes.push('Delegasi');

            if (allowedTypes.length === 0) {
                alert('Pemilihan ini tidak mengizinkan tipe user manapun untuk voting!');
                return;
            }

            new bootstrap.Modal(document.getElementById('generateModal')).show();
        }

        function toggleInputFields() {
            const userType = document.getElementById('userTypeSelect').value;
            const delegasiInputs = document.getElementById('delegasiInputs');
            const autoGenerateInfo = document.getElementById('autoGenerateInfo');

            if (userType === 'delegasi') {
                delegasiInputs.style.display = 'block';
                autoGenerateInfo.style.display = 'none';
            } else if (userType === 'anggota' || userType === 'alumni') {
                delegasiInputs.style.display = 'none';
                autoGenerateInfo.style.display = 'block';
                document.getElementById('userTypeLabel').textContent = userType;
            } else {
                delegasiInputs.style.display = 'none';
                autoGenerateInfo.style.display = 'none';
            }
        }

        async function generateCodes() {
            const userType = document.getElementById('userTypeSelect').value;
            
            if (!userType) {
                alert('Pilih tipe user terlebih dahulu!');
                return;
            }

            if (!selectedElectionId) {
                alert('Pilih pemilihan terlebih dahulu!');
                return;
            }

            try {
                let codes = [];

                if (userType === 'anggota') {
                    const { data: members, error } = await supabaseClient
                        .from('anggota')
                        .select('nama_lengkap, nim, user_id');

                    if (error) throw error;

                    if (!members || members.length === 0) {
                        alert('Tidak ada data anggota di database!');
                        return;
                    }

                    codes = members.map(m => ({
                        election_id: selectedElectionId,
                        code: generateRandomCode(),
                        voter_name: m.nama_lengkap,
                        voter_identifier: m.nim,
                        user_type: 'anggota',
                        role_type: 'anggota',
                        is_used: false,
                        is_active: true
                    }));

                } else if (userType === 'alumni') {
                    const { data: alumni, error } = await supabaseClient
                        .from('alumni')
                        .select('nama_lengkap, generasi, tahun_lulus, divisi, jabatan, user_id');

                    if (error) throw error;

                    if (!alumni || alumni.length === 0) {
                        alert('Tidak ada data alumni di database!');
                        return;
                    }

                    codes = alumni.map(a => ({
                        election_id: selectedElectionId,
                        code: `ALUMNI-${a.generasi}-${generateShortCode()}`,
                        voter_name: a.nama_lengkap,
                        voter_identifier: `Gen ${a.generasi} (${a.tahun_lulus || 'N/A'})`,
                        user_type: 'alumni',
                        role_type: 'alumni',
                        voter_metadata: JSON.stringify({ 
                            generasi: a.generasi, 
                            tahun_lulus: a.tahun_lulus,
                            jabatan: a.jabatan
                        }),
                        is_used: false,
                        is_active: true
                    }));

                } else if (userType === 'delegasi') {
                    const name = document.getElementById('delegasiName').value.trim();
                    const nim = document.getElementById('delegasiNim').value.trim();
                    const instansi = document.getElementById('delegasiInstansi').value.trim();

                    if (!name || !instansi) {
                        alert('Nama dan instansi harus diisi!');
                        return;
                    }

                    codes = [{
                        election_id: selectedElectionId,
                        code: `DELEGASI-${generateShortCode()}`,
                        voter_name: name,
                        voter_identifier: nim || null,
                        user_type: 'delegasi',
                        role_type: 'delegasi',
                        voter_metadata: JSON.stringify({ instansi: instansi }),
                        is_used: false,
                        is_verified: false,
                        is_active: true
                    }];
                }

                if (codes.length === 0) {
                    alert('Tidak ada kode yang akan digenerate!');
                    return;
                }

                const { error: insertError } = await supabaseClient
                    .from('access_codes')
                    .insert(codes);

                if (insertError) throw insertError;

                alert(`Berhasil generate ${codes.length} kode akses untuk ${userType}!`);
                
                bootstrap.Modal.getInstance(document.getElementById('generateModal')).hide();
                loadAccessCodes();

                document.getElementById('userTypeSelect').value = '';
                document.getElementById('delegasiName').value = '';
                document.getElementById('delegasiNim').value = '';
                document.getElementById('delegasiInstansi').value = '';
                toggleInputFields();

            } catch (error) {
                console.error('Error generating codes:', error);
                alert('Gagal generate kode: ' + error.message);
            }
        }

        function generateRandomCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 12; i++) {
                if (i > 0 && i % 4 === 0) code += '-';
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        function generateShortCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 8; i++) {
                if (i === 4) code += '-';
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        async function deleteCode(codeId) {
            if (!confirm('Yakin ingin menghapus kode ini?')) return;

            try {
                const { error } = await supabaseClient
                    .from('access_codes')
                    .delete()
                    .eq('id', codeId);

                if (error) throw error;

                showToast('Kode berhasil dihapus!');
                loadAccessCodes();

            } catch (error) {
                console.error('Error deleting code:', error);
                alert('Gagal menghapus kode: ' + error.message);
            }
        }

        function copyCode(code) {
            navigator.clipboard.writeText(code).then(() => {
                showToast('Kode berhasil disalin!');
            });
        }

        function exportToExcel() {
            if (allCodes.length === 0) {
                alert('Tidak ada data untuk diekspor!');
                return;
            }

            const excelData = allCodes.map(c => {
                let metadata = {};
                try {
                    metadata = c.voter_metadata ? JSON.parse(c.voter_metadata) : {};
                } catch (e) {}

                return {
                    'Kode Akses': c.code,
                    'Nama': c.voter_name || '-',
                    'Identitas': c.voter_identifier || '-',
                    'Tipe': c.user_type || c.role_type || '-',
                    'Info Tambahan': metadata.instansi || (metadata.generasi ? `Gen ${metadata.generasi}` : '-'),
                    'Status': c.is_used ? 'Terpakai' : 'Belum',
                    'Waktu Voting': c.voted_at || '-'
                };
            });

            const ws = XLSX.utils.json_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Access Codes');
            XLSX.writeFile(wb, `access-codes-${new Date().toISOString().split('T')[0]}.xlsx`);

            showToast('Data berhasil diekspor!');
        }

        function formatDateTime(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString('id-ID', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'alert alert-success position-fixed top-0 end-0 m-3';
            toast.style.zIndex = '9999';
            toast.innerHTML = `<i class="bi bi-check-circle me-2"></i>${message}`;
            document.body.appendChild(toast);

            setTimeout(() => toast.remove(), 3000);
        }

        window.addEventListener('load', loadPage);
    </script>
</body>
</html>